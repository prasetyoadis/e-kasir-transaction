/* =========================================
   KASIR POS LOGIC (RETAIL/MINIMARKET)
   File: public/js/dashboard/cashier/pos-logic.js
   ========================================= */

// --- 1. CONFIG & STATE ---
const API_BASE_URL = "http://192.168.43.6:8002/api"; // Sesuaikan IP/Domain backend
const TOKEN = localStorage.getItem('token');

let cart = []; // Menampung item belanja
let productsCache = []; // (Opsional) Simpan data produk lokal untuk pencarian cepat

// DOM Elements
const elements = {
    barcodeInput: document.getElementById("barcode_input"),
    qtyInput: document.getElementById("qty_input"),
    cartTable: document.getElementById("cart_table_body"),
    subTotalVal: document.getElementById("val_sub_total"),
    discountVal: document.getElementById("val_discount"),
    grandTotalVal: document.getElementById("val_grand_total"),
    cashInput: document.getElementById("cash_input"),
    changeInput: document.getElementById("change_input"),
    customerSelect: document.getElementById("customer_select"),
    btnProcess: document.querySelector(".btn-process") // Pastikan tombol bayar punya class ini
};

// --- 2. HELPER FUNCTIONS ---
const formatRupiah = (num) => {
    return new Intl.NumberFormat("id-ID", {
        style: "currency",
        currency: "IDR",
        minimumFractionDigits: 0
    }).format(num);
};

const parseRupiah = (str) => {
    return parseInt(str.replace(/[^0-9,-]+/g, "")) || 0;
};

// --- 3. CORE LOGIC: SEARCH & ADD ITEM ---

// Fungsi 1: Scan Barcode (Dipanggil saat Enter di input barcode)
async function handleScanBarcode(barcode) {
    if (!barcode) return;

    try {
        // A. Cek di keranjang dulu (untuk update Qty jika barang sama)
        const existingItem = cart.find(item => item.barcode === barcode);

        if (existingItem) {
            updateCartQty(existingItem.barcode, existingItem.qty + 1);
            clearInput();
            return;
        }

        // B. Jika belum ada, Fetch ke API
        const response = await fetch(`${API_BASE_URL}/products?barcode=${barcode}`, {
            headers: {
                'Authorization': `Bearer ${TOKEN}`,
                'Accept': 'application/json'
            }
        });

        const result = await response.json();

        // Sesuaikan dengan struktur JSON backend Anda (misal: result.data)
        const product = result.data || result;

        if (response.ok && product) {
            if (product.stock > 0) {
                addToCart(product);
            } else {
                alert(`Stok habis untuk ${product.name}!`);
            }
        } else {
            alert("Produk tidak ditemukan!");
        }
    } catch (error) {
        console.error("Error fetching product:", error);
        alert("Gagal mengambil data produk.");
    } finally {
        clearInput();
    }
}

function addToCart(product) {
    const newItem = {
        id: product.id,
        barcode: product.barcode,
        name: product.name,
        price: parseFloat(product.price),
        qty: 1,
        stock_max: product.stock // Simpan stok maksimal untuk validasi
    };

    cart.push(newItem);
    renderTable();
}

function clearInput() {
    elements.barcodeInput.value = "";
    elements.barcodeInput.focus();
}

// --- 4. CART MANAGEMENT & CALCULATION ---

function updateCartQty(barcode, newQty) {
    const item = cart.find(i => i.barcode === barcode);
    if (!item) return;

    if (newQty > item.stock_max) {
        alert("Stok tidak mencukupi!");
        return;
    }

    if (newQty <= 0) {
        // Hapus item jika qty 0
        cart = cart.filter(i => i.barcode !== barcode);
    } else {
        item.qty = newQty;
    }
    renderTable();
}

function renderTable() {
    elements.cartTable.innerHTML = "";

    cart.forEach((item, index) => {
        const totalItemPrice = item.price * item.qty;

        const row = `
            <tr>
                <td>${index + 1}</td>
                <td>${item.barcode}</td>
                <td>${item.name}</td>
                <td>${formatRupiah(item.price)}</td>
                <td>
                    <input type="number" min="1" value="${item.qty}"
                           class="qty-control"
                           onchange="updateCartQty('${item.barcode}', this.value)">
                </td>
                <td>${formatRupiah(totalItemPrice)}</td>
                <td>
                    <button onclick="updateCartQty('${item.barcode}', 0)" class="btn-delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        elements.cartTable.innerHTML += row;
    });

    calculateTotals();
}

function calculateTotals() {
    // 1. Hitung Subtotal
    const subTotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);

    // 2. Hitung Diskon (Logika Member)
    let discount = 0;
    const customerType = elements.customerSelect.value;

    if (customerType === 'Member') {
        discount = subTotal * 0.05; // Contoh: Diskon 5% untuk member
    }

    // 3. Grand Total
    const grandTotal = subTotal - discount;

    // 4. Update UI
    elements.subTotalVal.innerText = formatRupiah(subTotal);
    elements.discountVal.innerText = formatRupiah(discount);
    elements.grandTotalVal.innerText = formatRupiah(grandTotal);

    // Hitung kembalian real-time jika sudah ada input uang
    calculateChange();
}

function calculateChange() {
    const grandTotal = parseRupiah(elements.grandTotalVal.innerText);
    const cash = parseFloat(elements.cashInput.value) || 0;

    const change = cash - grandTotal;

    // Tampilkan kembalian (jangan minus di UI)
    elements.changeInput.value = change >= 0 ? formatRupiah(change) : formatRupiah(0);

    // Visual cue: text merah jika kurang
    elements.changeInput.style.color = change < 0 ? 'red' : 'black';
}

// --- 5. TRANSACTION SUBMISSION (CHECKOUT) ---

async function processPayment() {
    // A. Validasi
    const grandTotal = parseRupiah(elements.grandTotalVal.innerText);
    const cash = parseFloat(elements.cashInput.value) || 0;

    if (cart.length === 0) return alert("Keranjang kosong!");
    if (cash < grandTotal) return alert("Uang tunai kurang!");

    if (!confirm("Proses transaksi ini?")) return;

    // B. Siapkan Data JSON
    const payload = {
        customer_type: elements.customerSelect.value, // 'General' or 'Member'
        total_items: cart.length,
        sub_total: parseRupiah(elements.subTotalVal.innerText),
        discount_amount: parseRupiah(elements.discountVal.innerText),
        grand_total: grandTotal,
        cash_received: cash,
        change_amount: cash - grandTotal,
        payment_method: "cash",
        items: cart.map(item => ({
            product_id: item.id,
            barcode: item.barcode,
            quantity: item.qty,
            unit_price: item.price,
            total_price: item.price * item.qty
        }))
    };

    // C. Kirim ke API
    try {
        const response = await fetch(`${API_BASE_URL}/transactions/pos`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${TOKEN}`
            },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (response.ok) {
            // D. Cetak Struk
            printReceipt(payload);

            // E. Reset Halaman
            cart = [];
            renderTable();
            elements.cashInput.value = "";
            elements.changeInput.value = "";
            alert("Transaksi Berhasil!");
        } else {
            throw new Error(result.message || "Gagal menyimpan transaksi");
        }

    } catch (error) {
        console.error(error);
        alert("Gagal memproses pembayaran: " + error.message);
    }
}

// --- 6. PRINT RECEIPT (Struk) ---
function printReceipt(data) {
    // Anda bisa menggunakan window.print() dengan CSS @media print
    // atau mengisi div khusus struk
    const recSub = document.getElementById('rec-subtotal'); // Pastikan ID ini ada di Blade struk
    const recGrand = document.getElementById('rec-grand-total');
    const recCash = document.getElementById('rec-cash');
    const recChange = document.getElementById('rec-change');

    if(recSub) recSub.innerText = formatRupiah(data.sub_total);
    if(recGrand) recGrand.innerText = formatRupiah(data.grand_total);
    if(recCash) recCash.innerText = formatRupiah(data.cash_received);
    if(recChange) recChange.innerText = formatRupiah(data.change_amount);

    window.print();
}


// --- 7. EVENT LISTENERS ---

document.addEventListener("DOMContentLoaded", () => {
    // Fokus ke barcode saat load
    elements.barcodeInput.focus();

    // Listener Scan Barcode (Enter key)
    elements.barcodeInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            handleScanBarcode(e.target.value);
        }
    });

    // Listener Hitung Kembalian
    elements.cashInput.addEventListener("input", calculateChange);

    // Listener Ganti Customer (Update Diskon)
    elements.customerSelect.addEventListener("change", calculateTotals);

    if(elements.btnProcess) {
        elements.btnProcess.addEventListener("click", (e) => {
            e.preventDefault();
            processPayment();
        });
    }
});
